<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menedżer Promptów</title>
    
    <!-- Zasoby ładowane z sieci CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <style>
        html {
            font-size: 85%;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style for draggable items */
        .dragging {
            opacity: 0.5;
            background: #c7d2fe;
        }
        .drag-over {
            border-top: 2px solid #4f46e5;
        }
        /* Snippet dropdown */
        .snippet-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 20;
            max-height: 200px;
            overflow-y: auto;
        }
        .snippet-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .snippet-item:hover {
            background-color: #f1f5f9;
        }
        /* Quill Editor Styling */
        .ql-container.ql-snow {
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .ql-toolbar.ql-snow {
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 0;
        }
        .editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .ql-editor {
            flex-grow: 1;
            resize: vertical;
            overflow-y: auto;
        }
        .ql-editor p {
            margin-bottom: 1rem;
        }
        .ql-editor li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold text-slate-700">Menedżer Promptów</h1>
            <div class="flex items-center space-x-2">
                <button id="manage-snippets-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Zarządzaj wstawkami</button>
                <button id="import-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                    Importuj (JSON)
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json">
                <button id="export-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                    Eksportuj (JSON)
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col lg:flex-row p-4 gap-4 overflow-hidden">
            
            <!-- Left Panel: Projects, Prompts, Versions -->
            <div class="w-full lg:w-1/3 flex flex-col md:flex-row lg:flex-col gap-4">
                <!-- Projects Column -->
                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold">Projekty</h2>
                        <button id="add-project-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-colors">+</button>
                    </div>
                    <ul id="projects-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-2"></ul>
                </div>

                <!-- Prompts Column -->
                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold">Prompty</h2>
                        <button id="add-prompt-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed">+</button>
                    </div>
                    <ul id="prompts-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-2"></ul>
                </div>
                
                <!-- Versions Column -->
                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold">Wersje</h2>
                        <button id="add-version-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed">+</button>
                    </div>
                    <ul id="versions-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-2"></ul>
                </div>
            </div>

            <!-- Right Panel: Editor -->
            <div class="w-full lg:w-2/3 bg-white p-4 rounded-xl shadow-sm flex flex-col gap-4">
                <div id="editor-view" class="flex-grow flex flex-col gap-4 hidden">
                    <!-- Main Prompt Content -->
                    <div class="flex-grow flex flex-col">
                        <div class="flex justify-between items-center mb-1">
                            <label for="prompt-content-editor" class="block text-sm font-medium text-slate-600">Treść promptu (zapisywana automatycznie)</label>
                            <div class="relative">
                                <button id="insert-snippet-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">Wstaw snippet</button>
                                <div id="snippet-dropdown" class="snippet-dropdown hidden"></div>
                            </div>
                        </div>
                        <div id="prompt-content-editor" class="h-full"></div>
                    </div>

                    <!-- Temporary Content -->
                    <div>
                        <label for="temp-content" class="block text-sm font-medium text-slate-600 mb-1">Treść tymczasowa (nie jest zapisywana)</label>
                        <textarea id="temp-content" rows="3" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                        <div class="flex justify-end mt-2">
                             <button id="copy-btn-1" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                                Kopiuj cały prompt
                            </button>
                        </div>
                    </div>
                    
                    <!-- Combined Output -->
                    <div class="flex-grow flex flex-col">
                        <label for="combined-output-preview" class="block text-sm font-medium text-slate-600 mb-1">Końcowy prompt (podgląd)</label>
                        <div id="combined-output-preview" class="w-full h-full flex-grow p-3 border bg-slate-50 border-slate-300 rounded-lg overflow-y-auto custom-scrollbar"></div>
                         <div class="flex justify-end mt-2">
                             <button id="copy-btn-2" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                                Kopiuj cały prompt
                            </button>
                        </div>
                    </div>
                </div>
                <div id="placeholder-view" class="flex-grow flex items-center justify-center text-center text-slate-500">
                    <div>
                        <h3 class="text-xl font-semibold">Witaj w Menedżerze Promptów!</h3>
                        <p class="mt-2">Dodaj swój pierwszy projekt, aby zacząć.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Snippets Modal -->
    <div id="snippet-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-5xl flex flex-col gap-4 max-h-[90vh]">
            <h2 class="text-xl font-bold">Zarządzaj wstawkami (snippetami)</h2>
            <div class="flex flex-col md:flex-row gap-4 flex-grow min-h-0">
                <!-- Form -->
                <div class="w-full md:w-1/2 flex flex-col gap-4">
                    <h3 id="snippet-form-title" class="text-lg font-semibold">Dodaj nową wstawkę</h3>
                    <input type="hidden" id="snippet-id-input">
                    <div>
                        <label for="snippet-name-input" class="block text-sm font-medium text-slate-600">Nazwa (bez spacji, np. 'formalny_ton')</label>
                        <input type="text" id="snippet-name-input" class="mt-1 w-full p-2 border border-slate-300 rounded-lg">
                    </div>
                    <div class="flex-grow flex flex-col">
                        <label for="snippet-content-editor" class="block text-sm font-medium text-slate-600">Treść wstawki</label>
                        <div id="snippet-content-editor" class="mt-1 flex-grow h-full"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="cancel-snippet-edit-btn" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg font-semibold hidden">Anuluj</button>
                        <button id="save-snippet-btn" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-semibold">Zapisz</button>
                    </div>
                </div>
                <!-- List -->
                <div class="w-full md:w-1/2 flex flex-col">
                    <h3 class="text-lg font-semibold mb-2">Istniejące wstawki</h3>
                    <ul id="snippets-list-modal" class="flex-grow overflow-y-auto custom-scrollbar border rounded-lg p-2 space-y-2">
                        <!-- Snippets will be rendered here -->
                    </ul>
                </div>
            </div>
             <button id="close-snippet-modal-btn" class="mt-4 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-semibold self-center">Zamknij</button>
        </div>
    </div>

    <!-- Custom Modal for confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Czy na pewno?</h3>
            <p id="modal-text" class="text-slate-600 mb-6">Tej operacji nie można cofnąć.</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg font-semibold">Anuluj</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold">Usuń</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let state = {
            projects: [],
            snippets: [],
            selectedProjectId: null,
            selectedPromptId: null,
            selectedVersionId: null,
        };

        // --- DOM ELEMENTS ---
        const projectsList = document.getElementById('projects-list');
        const promptsList = document.getElementById('prompts-list');
        const versionsList = document.getElementById('versions-list');
        const addProjectBtn = document.getElementById('add-project-btn');
        const addPromptBtn = document.getElementById('add-prompt-btn');
        const addVersionBtn = document.getElementById('add-version-btn');
        const tempContent = document.getElementById('temp-content');
        const combinedOutputPreview = document.getElementById('combined-output-preview');
        const copyBtn1 = document.getElementById('copy-btn-1');
        const copyBtn2 = document.getElementById('copy-btn-2');
        const editorView = document.getElementById('editor-view');
        const placeholderView = document.getElementById('placeholder-view');
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const importFile = document.getElementById('import-file');
        
        // Snippet Elements
        const manageSnippetsBtn = document.getElementById('manage-snippets-btn');
        const snippetModal = document.getElementById('snippet-modal');
        const closeSnippetModalBtn = document.getElementById('close-snippet-modal-btn');
        const snippetFormTitle = document.getElementById('snippet-form-title');
        const snippetIdInput = document.getElementById('snippet-id-input');
        const snippetNameInput = document.getElementById('snippet-name-input');
        const saveSnippetBtn = document.getElementById('save-snippet-btn');
        const cancelSnippetEditBtn = document.getElementById('cancel-snippet-edit-btn');
        const snippetsListModal = document.getElementById('snippets-list-modal');
        const insertSnippetBtn = document.getElementById('insert-snippet-btn');
        const snippetDropdown = document.getElementById('snippet-dropdown');

        // Confirmation Modal Elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');

        let confirmationCallback = null;
        
        // --- QUILL EDITOR INSTANCES ---
        const quillToolbarOptions = [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
        ];

        const promptEditor = new Quill('#prompt-content-editor', {
            modules: { toolbar: quillToolbarOptions },
            theme: 'snow'
        });

        const snippetEditor = new Quill('#snippet-content-editor', {
            modules: { toolbar: quillToolbarOptions },
            theme: 'snow'
        });


        // --- DATA PERSISTENCE ---
        const saveData = () => {
            try {
                localStorage.setItem('promptManagerData', JSON.stringify(state));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                alert("Nie udało się zapisać danych. Pamięć lokalna może być pełna.");
            }
        };

        const loadData = () => {
            const data = localStorage.getItem('promptManagerData');
            if (data) {
                try {
                    const parsedData = JSON.parse(data);
                    if (parsedData && Array.isArray(parsedData.projects)) {
                        state = parsedData;
                        if (!state.snippets) state.snippets = []; // Backward compatibility
                    }
                } catch (e) {
                    console.error("Error parsing data from localStorage:", e);
                    state = { projects: [], snippets: [], selectedProjectId: null, selectedPromptId: null, selectedVersionId: null };
                }
            }
        };

        // --- UTILITY FUNCTIONS ---
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const findProject = (projectId) => state.projects.find(p => p.id === projectId);
        const findPrompt = (projectId, promptId) => findProject(projectId)?.prompts.find(p => p.id === promptId);
        const findVersion = (projectId, promptId, versionId) => findPrompt(projectId, promptId)?.versions.find(v => v.id === versionId);
        
        const getSelectedProject = () => findProject(state.selectedProjectId);
        const getSelectedPrompt = () => findPrompt(state.selectedProjectId, state.selectedPromptId);
        const getSelectedVersion = () => findVersion(state.selectedProjectId, state.selectedPromptId, state.selectedVersionId);

        // --- SNIPPET FUNCTIONS ---
        const replaceSnippets = (text) => {
            if (!text) return '';
            return text.replace(/\{\{([^}]+)\}\}/g, (match, snippetName) => {
                const snippet = state.snippets.find(s => s.name === snippetName.trim());
                // Snippet content is HTML, so it will be rendered as such
                return snippet ? snippet.content : match; 
            });
        };

        const renderSnippetsInModal = () => {
            snippetsListModal.innerHTML = '';
            if (state.snippets.length === 0) {
                snippetsListModal.innerHTML = '<p class="text-slate-500 text-center">Brak zapisanych wstawek.</p>';
                return;
            }
            state.snippets.forEach(snippet => {
                const li = document.createElement('li');
                li.className = 'p-2 border-b flex justify-between items-center';
                li.innerHTML = `
                    <strong class="font-semibold flex-grow truncate">${snippet.name}</strong>
                    <div class="flex gap-2 ml-2">
                        <button data-id="${snippet.id}" class="edit-snippet-btn text-blue-500 hover:text-blue-700">Edytuj</button>
                        <button data-id="${snippet.id}" class="delete-snippet-btn text-red-500 hover:text-red-700">Usuń</button>
                    </div>
                `;
                snippetsListModal.appendChild(li);
            });
        };

        const resetSnippetForm = () => {
            snippetFormTitle.textContent = 'Dodaj nową wstawkę';
            snippetIdInput.value = '';
            snippetNameInput.value = '';
            snippetEditor.root.innerHTML = '';
            cancelSnippetEditBtn.classList.add('hidden');
        };
        
        const handleSaveSnippet = () => {
            const id = snippetIdInput.value;
            const name = snippetNameInput.value.trim().replace(/\s+/g, '_');
            const content = snippetEditor.root.innerHTML;
            const hasContent = snippetEditor.getText().trim().length > 0;

            if (!name || !hasContent) {
                alert('Nazwa i treść wstawki nie mogą być puste.');
                return;
            }

            const isNameTaken = state.snippets.some(s => s.name === name && s.id !== id);
            if (isNameTaken) {
                alert('Wstawka o tej nazwie już istnieje.');
                return;
            }

            if (id) { // Editing
                const snippet = state.snippets.find(s => s.id === id);
                if (snippet) {
                    snippet.name = name;
                    snippet.content = content;
                }
            } else { // Adding
                state.snippets.unshift({ id: generateId(), name, content });
            }

            saveData();
            renderSnippetsInModal();
            resetSnippetForm();
            updateCombinedOutput();
        };

        const handleEditSnippet = (id) => {
            const snippet = state.snippets.find(s => s.id === id);
            if (snippet) {
                snippetFormTitle.textContent = 'Edytuj wstawkę';
                snippetIdInput.value = snippet.id;
                snippetNameInput.value = snippet.name;
                snippetEditor.root.innerHTML = snippet.content;
                cancelSnippetEditBtn.classList.remove('hidden');
            }
        };

        const handleDeleteSnippet = (id) => {
            showConfirmation('Usunąć wstawkę?', 'Tej operacji nie można cofnąć.', () => {
                state.snippets = state.snippets.filter(s => s.id !== id);
                saveData();
                renderSnippetsInModal();
                updateCombinedOutput();
            });
        };

        const renderSnippetDropdown = () => {
            snippetDropdown.innerHTML = '';
            if (state.snippets.length === 0) {
                snippetDropdown.innerHTML = '<div class="p-2 text-slate-500">Brak wstawek</div>';
            } else {
                state.snippets.forEach(snippet => {
                    const item = document.createElement('div');
                    item.className = 'snippet-item';
                    item.textContent = snippet.name;
                    item.onclick = () => {
                        insertSnippetPlaceholder(snippet.name);
                        snippetDropdown.classList.add('hidden');
                    };
                    snippetDropdown.appendChild(item);
                });
            }
        };

        const insertSnippetPlaceholder = (name) => {
            const placeholder = `{{${name}}}`;
            const range = promptEditor.getSelection(true);
            promptEditor.insertText(range.index, placeholder);
        };


        // --- RENDER FUNCTIONS ---
        const renderAll = () => {
            renderProjects();
            renderPrompts();
            renderVersions();
            renderEditor();
            updateButtonStates();
        };

        const createListItem = ({ id, name, type, selected, onDelete, onSelect, onNameUpdate }) => {
            const li = document.createElement('li');
            li.className = `group flex items-center justify-between p-2 rounded-lg cursor-pointer transition-colors ${selected ? 'bg-indigo-100 text-indigo-800 font-semibold' : 'hover:bg-slate-100'}`;
            li.dataset.id = id;
            li.dataset.type = type;
            li.draggable = true;

            const nameSpan = document.createElement('span');
            nameSpan.textContent = name;
            nameSpan.className = 'flex-grow truncate';
            li.appendChild(nameSpan);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
            deleteBtn.className = 'text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity ml-2';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                onDelete(id);
            };
            li.appendChild(deleteBtn);

            li.onclick = () => onSelect(id);

            nameSpan.ondblclick = (e) => {
                e.stopPropagation();
                const input = document.createElement('input');
                input.type = 'text';
                input.value = name;
                input.className = 'w-full bg-transparent border-b-2 border-indigo-500 focus:outline-none';
                nameSpan.replaceWith(input);
                input.focus();
                
                const saveName = () => {
                    const newName = input.value.trim();
                    if (newName && newName !== name) {
                        onNameUpdate(id, newName);
                    } else {
                        input.replaceWith(nameSpan);
                    }
                };
                
                input.onblur = saveName;
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') input.blur();
                    if (e.key === 'Escape') {
                        input.value = name;
                        input.blur();
                    }
                };
            };

            return li;
        };
        
        const renderProjects = () => {
            projectsList.innerHTML = '';
            state.projects.forEach(project => {
                const li = createListItem({
                    id: project.id,
                    name: project.name,
                    type: 'project',
                    selected: project.id === state.selectedProjectId,
                    onDelete: (id) => showConfirmation('Usunąć projekt?', `Spowoduje to usunięcie wszystkich promptów i wersji w projekcie "${project.name}".`, () => deleteProject(id)),
                    onSelect: selectProject,
                    onNameUpdate: updateProjectName
                });
                projectsList.appendChild(li);
            });
        };

        const renderPrompts = () => {
            promptsList.innerHTML = '';
            const project = getSelectedProject();
            if (project && project.prompts) {
                project.prompts.forEach(prompt => {
                    const li = createListItem({
                        id: prompt.id,
                        name: prompt.name,
                        type: 'prompt',
                        selected: prompt.id === state.selectedPromptId,
                        onDelete: (id) => showConfirmation('Usunąć prompt?', `Spowoduje to usunięcie wszystkich wersji w prompcie "${prompt.name}".`, () => deletePrompt(id)),
                        onSelect: selectPrompt,
                        onNameUpdate: updatePromptName
                    });
                    promptsList.appendChild(li);
                });
            }
        };

        const renderVersions = () => {
            versionsList.innerHTML = '';
            const prompt = getSelectedPrompt();
            if (prompt && prompt.versions) {
                prompt.versions.forEach(version => {
                    const li = createListItem({
                        id: version.id,
                        name: version.name,
                        type: 'version',
                        selected: version.id === state.selectedVersionId,
                        onDelete: (id) => showConfirmation('Usunąć wersję?', `Czy na pewno chcesz usunąć wersję "${version.name}"?`, () => deleteVersion(id)),
                        onSelect: selectVersion,
                        onNameUpdate: updateVersionName
                    });
                    versionsList.appendChild(li);
                });
            }
        };

        const renderEditor = () => {
            const version = getSelectedVersion();
            promptEditor.disable();
            if (version) {
                promptEditor.enable();
                editorView.classList.remove('hidden');
                placeholderView.classList.add('hidden');
                promptEditor.root.innerHTML = version.content || '';
                updateCombinedOutput();
            } else {
                editorView.classList.add('hidden');
                placeholderView.classList.remove('hidden');
                promptEditor.root.innerHTML = '';
                tempContent.value = '';
                combinedOutputPreview.innerHTML = '';
            }
        };

        const updateButtonStates = () => {
            addPromptBtn.disabled = !state.selectedProjectId;
            addVersionBtn.disabled = !state.selectedPromptId;
        };

        // --- EVENT HANDLERS & ACTIONS ---

        // Selection
        const selectProject = (projectId) => {
            if (state.selectedProjectId !== projectId) {
                state.selectedProjectId = projectId;
                state.selectedPromptId = null;
                state.selectedVersionId = null;
                renderAll();
            }
        };

        const selectPrompt = (promptId) => {
            if (state.selectedPromptId !== promptId) {
                state.selectedPromptId = promptId;
                state.selectedVersionId = null;
                const prompt = getSelectedPrompt();
                if (prompt && prompt.versions && prompt.versions.length > 0) {
                    state.selectedVersionId = prompt.versions[0].id;
                }
                renderAll();
            }
        };

        const selectVersion = (versionId) => {
            if (state.selectedVersionId !== versionId) {
                state.selectedVersionId = versionId;
                renderAll();
            }
        };

        // Add
        addProjectBtn.onclick = () => {
            const newProject = {
                id: generateId(),
                name: `Nowy Projekt ${state.projects.length + 1}`,
                prompts: []
            };
            state.projects.unshift(newProject);
            selectProject(newProject.id);
            saveData();
        };

        addPromptBtn.onclick = () => {
            const project = getSelectedProject();
            if (project) {
                const newPrompt = {
                    id: generateId(),
                    name: `Nowy Prompt ${project.prompts.length + 1}`,
                    versions: []
                };
                project.prompts.unshift(newPrompt);
                selectPrompt(newPrompt.id);
                saveData();
            }
        };

        addVersionBtn.onclick = () => {
            const prompt = getSelectedPrompt();
            if (prompt) {
                const newVersion = {
                    id: generateId(),
                    name: `Wersja ${prompt.versions.length + 1}`,
                    content: ''
                };
                prompt.versions.unshift(newVersion);
                selectVersion(newVersion.id);
                saveData();
            }
        };

        // Delete
        const deleteProject = (projectId) => {
            state.projects = state.projects.filter(p => p.id !== projectId);
            if (state.selectedProjectId === projectId) {
                state.selectedProjectId = null;
                state.selectedPromptId = null;
                state.selectedVersionId = null;
            }
            renderAll();
            saveData();
        };

        const deletePrompt = (promptId) => {
            const project = getSelectedProject();
            if (project) {
                project.prompts = project.prompts.filter(p => p.id !== promptId);
                if (state.selectedPromptId === promptId) {
                    state.selectedPromptId = null;
                    state.selectedVersionId = null;
                }
                renderAll();
                saveData();
            }
        };

        const deleteVersion = (versionId) => {
            const prompt = getSelectedPrompt();
            if (prompt) {
                const versionIndex = prompt.versions.findIndex(v => v.id === versionId);
                prompt.versions = prompt.versions.filter(v => v.id !== versionId);
                if (state.selectedVersionId === versionId) {
                    state.selectedVersionId = null;
                    if (prompt.versions.length > 0) {
                        const newIndex = Math.max(0, versionIndex - 1);
                        state.selectedVersionId = prompt.versions[newIndex].id;
                    }
                }
                renderAll();
                saveData();
            }
        };

        // Update
        const updateProjectName = (id, newName) => {
            const project = findProject(id);
            if (project) {
                project.name = newName;
                renderProjects();
                saveData();
            }
        };

        const updatePromptName = (id, newName) => {
            const prompt = findPrompt(state.selectedProjectId, id);
            if (prompt) {
                prompt.name = newName;
                renderPrompts();
                saveData();
            }
        };

        const updateVersionName = (id, newName) => {
            const version = findVersion(state.selectedProjectId, state.selectedPromptId, id);
            if (version) {
                version.name = newName;
                renderVersions();
                saveData();
            }
        };

        promptEditor.on('text-change', (delta, oldDelta, source) => {
            if (source === 'user') {
                const version = getSelectedVersion();
                if (version) {
                    version.content = promptEditor.root.innerHTML;
                    updateCombinedOutput();
                    saveData();
                }
            }
        });

        tempContent.oninput = updateCombinedOutput;

        function updateCombinedOutput() {
            const mainContent = promptEditor.root.innerHTML || '';
            const processedMain = replaceSnippets(mainContent);
            const temp = tempContent.value || '';
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = processedMain;
            
            combinedOutputPreview.innerHTML = tempDiv.innerHTML;
            
            const tempText = temp ? `\n\n${temp}` : '';
            const finalPlainText = combinedOutputPreview.innerText + tempText;
            
            // Set a data attribute to store plain text for copying
            combinedOutputPreview.dataset.plainText = finalPlainText.trim();
        }

        // Copy
        const copyToClipboard = (btn) => {
            const textToCopy = combinedOutputPreview.dataset.plainText;
            if (!textToCopy) return;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = btn.innerHTML;
                btn.innerHTML = 'Skopiowano!';
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-teal-500', 'hover:bg-teal-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-500');
                    btn.classList.add('bg-teal-500', 'hover:bg-teal-600');
                }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert('Nie udało się skopiować tekstu.');
            });
        };
        copyBtn1.onclick = () => copyToClipboard(copyBtn1);
        copyBtn2.onclick = () => copyToClipboard(copyBtn2);


        // Import / Export
        exportBtn.onclick = () => {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `prompt-manager-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        importBtn.onclick = () => importFile.click();
        importFile.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedState = JSON.parse(event.target.result);
                    if (importedState && Array.isArray(importedState.projects)) {
                        showConfirmation(
                            'Importować dane?', 
                            'Spowoduje to nadpisanie wszystkich obecnych projektów i promptów. Kontynuować?',
                            () => {
                                state = importedState;
                                if (!state.snippets) state.snippets = [];
                                state.selectedProjectId = null;
                                state.selectedPromptId = null;
                                state.selectedVersionId = null;
                                saveData();
                                renderAll();
                                alert('Dane zostały pomyślnie zaimportowane.');
                            }
                        );
                    } else {
                        throw new Error('Invalid file format');
                    }
                } catch (err) {
                    console.error('Error importing file:', err);
                    alert('Błąd podczas importu pliku. Upewnij się, że plik jest poprawnym plikiem JSON z tego menedżera.');
                } finally {
                    importFile.value = '';
                }
            };
            reader.readAsText(file);
        };
        
        // Confirmation Modal
        const showConfirmation = (title, text, callback) => {
            modalTitle.textContent = title;
            modalText.textContent = text;
            confirmationCallback = callback;
            confirmationModal.classList.remove('hidden');
        };

        modalConfirm.onclick = () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        };

        modalCancel.onclick = () => {
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        };
        
        // Drag and Drop
        let draggedItem = null;

        const handleDragStart = (e) => {
            draggedItem = e.target;
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        };

        const handleDragEnd = (e) => {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedItem = null;
        };

        const handleDragOver = (e) => {
            e.preventDefault();
            const target = e.target.closest('li');
            if (target && draggedItem && target.dataset.type === draggedItem.dataset.type) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                target.classList.add('drag-over');
            }
        };

        const handleDrop = (e) => {
            e.preventDefault();
            const dropTarget = e.target.closest('li');
            if (!dropTarget || !draggedItem || dropTarget.dataset.type !== draggedItem.dataset.type) {
                return;
            }

            const type = draggedItem.dataset.type;
            const draggedId = draggedItem.dataset.id;
            const targetId = dropTarget.dataset.id;

            let list;
            if (type === 'project') {
                list = state.projects;
            } else if (type === 'prompt') {
                const project = getSelectedProject();
                if (project) list = project.prompts;
            } else if (type === 'version') {
                const prompt = getSelectedPrompt();
                if(prompt) list = prompt.versions;
            }

            if (!list) return;

            const draggedIndex = list.findIndex(item => item.id === draggedId);
            const targetIndex = list.findIndex(item => item.id === targetId);

            if (draggedIndex !== -1 && targetIndex !== -1) {
                const [removed] = list.splice(draggedIndex, 1);
                list.splice(targetIndex, 0, removed);

                saveData();
                if (type === 'project') renderProjects();
                if (type === 'prompt') renderPrompts();
                if (type === 'version') renderVersions();
            }
        };

        projectsList.addEventListener('dragstart', handleDragStart);
        projectsList.addEventListener('dragend', handleDragEnd);
        projectsList.addEventListener('dragover', handleDragOver);
        projectsList.addEventListener('drop', handleDrop);

        promptsList.addEventListener('dragstart', handleDragStart);
        promptsList.addEventListener('dragend', handleDragEnd);
        promptsList.addEventListener('dragover', handleDragOver);
        promptsList.addEventListener('drop', handleDrop);
        
        versionsList.addEventListener('dragstart', handleDragStart);
        versionsList.addEventListener('dragend', handleDragEnd);
        versionsList.addEventListener('dragover', handleDragOver);
        versionsList.addEventListener('drop', handleDrop);

        // Snippet Event Listeners
        manageSnippetsBtn.onclick = () => {
            renderSnippetsInModal();
            snippetModal.classList.remove('hidden');
        };
        closeSnippetModalBtn.onclick = () => snippetModal.classList.add('hidden');
        saveSnippetBtn.onclick = handleSaveSnippet;
        cancelSnippetEditBtn.onclick = resetSnippetForm;

        snippetsListModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-snippet-btn')) {
                handleEditSnippet(e.target.dataset.id);
            }
            if (e.target.classList.contains('delete-snippet-btn')) {
                handleDeleteSnippet(e.target.dataset.id);
            }
        });

        insertSnippetBtn.onclick = () => {
            renderSnippetDropdown();
            snippetDropdown.classList.toggle('hidden');
        };

        // Hide dropdown if clicked outside
        document.addEventListener('click', (e) => {
            if (!insertSnippetBtn.contains(e.target) && !snippetDropdown.contains(e.target)) {
                snippetDropdown.classList.add('hidden');
            }
        });


        // --- INITIALIZATION ---
        loadData();
        renderAll();
    });
    </script>
</body>
</html>
